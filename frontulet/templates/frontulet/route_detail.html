{% extends "frontulet/base.html" %}
{% load staticfiles %}
{% load leaflet_tags %}


{% block bootstrap_css %}
    {{ block.super }}
    <link rel="stylesheet" href={% static "frontulet/bootstrap-3.2.0-dist/css/bootstrap-theme.min.css" %}>
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
{% endblock %}

{% block head_additions %}
    <link rel="stylesheet" href={% static "frontulet/form_style.css" %}>

    <link rel="stylesheet" href={% static "frontulet/route_detail_style.css" %}>

    <script src="{% static "frontulet/map_scripts.js" %}"></script>

    {% leaflet_js %}
    {% leaflet_css %}


    <script type="text/javascript">

        var wp_icon_class = L.Icon.Default.extend({
            options: {
                iconUrl: '{% static "frontulet/icons/map_markers/ic_marker_wp.png" %}'
            }
        });

        var poi_icon_class = L.Icon.Default.extend({
            options: {
                iconUrl: '{% static "frontulet/icons/map_markers/ic_marker_poi.png" %}'
            }
        });

        var wp_icon = new wp_icon_class;
        var poi_icon = new poi_icon_class;


        var poi_markers = new L.LayerGroup();
        var wp_markers = new L.LayerGroup();

        var these_latlngs = [];

        {% for step in steps %}

            {% if step.order %}

                these_latlngs[these_latlngs.length] = [{{  step.latitude }}, {{ step.longitude }}];

            {% else %}

                {% for highlight in step.highlights.all %}


                    {% if highlight.type == 1 %}

                        wp_markers.addLayer(L.marker([{{ step.latitude }}, {{ step.longitude }}], {icon: wp_icon}));

                    {% elif highlight.type == 0 %}

                        poi_markers.addLayer(L.marker([{{ step.latitude }}, {{ step.longitude }}], {icon: poi_icon}));


                    {% endif %}

                {% endfor %}

            {% endif %}


        {% endfor %}

        function map_init_basic(map, options) {

            L.polyline(these_latlngs, {weight: 5, opacity: 1, color: 'black'}).addTo(map);
            L.polyline(these_latlngs, {weight: 2, opacity: 1, color: 'red'}).addTo(map);

            var bounds = new L.LatLngBounds(these_latlngs);
            map.fitBounds(bounds);

            wp_markers.addTo(map);
            poi_markers.addTo(map);

        }

    </script>


{% endblock %}


{% block body_property_extras %}role="document"{% endblock %}

{% block page_id %}routes{% endblock %}

{% block main_body %}

    <div class="container theme-showcase" role="main">


        <div class="page-header">
            <h1>{{ name }}
                <small>{{ short_description }} </small>
            <a class="btn btn-default" href={% url "edit_route" id %} role="button"> <span class="glyphicon glyphicon-pencil"></span> </a></h1>
            <p>{{ description }}</p>

        </div>

        <div id="erulet_map" class="route_map-container"></div>
        <br>

        {% for highlight in these_highlights %}

            <script>
                eval("function map_init_highlight{{ highlight.id }}(map, options) {L.polyline(these_latlngs, {weight: 5, opacity: 1, color: 'black'}).addTo(map);L.polyline(these_latlngs, {weight: 2, opacity: 1, color: 'red'}).addTo(map);L.marker([{{ highlight.step.latitude }}, {{ highlight.step.longitude }}],{icon:{% if highlight.type == 0 %}poi_icon{% else %}wp_icon{% endif %}}).addTo(map);map.setView([{{ highlight.step.latitude }}, {{ highlight.step.longitude }}], 18)}");
            </script>

            <br>
            <div class="row">

                <div class="col-md-4">
                    <h3>{{ highlight.name }} <a class="btn btn-default" href={% url "edit_highlight" id highlight.id %} role="button"> <span class="glyphicon glyphicon-pencil"></span> </a></h3>

                    <p>{{ highlight.long_text }}</p>
                </div>

                <div class="col-md-4">
                    {% if highlight.image %}
                       <a href={{ highlight.media.url }}><img width=100% src={{ highlight.media.url }}></a>
                    {% elif highlight.media_ext == 'mp4' %}
                        <video width="100%" height="100%" controls>
                            <source type="video/mp4" src={{ highlight.media.url }}>
                            Your browser does not support the video tag.
                        </video>
                    {% endif %}

                </div>

                <div class="col-md-4">
                    <div id="highlight{{ highlight.id }}" class="highlight-container"></div>
                </div>

            </div>
            <br>
        {% endfor %}

    </div>

{% endblock %}

{% block body_scripts %}

    <script type="text/javascript">
        (function () {
            function loadmap() {
                var centerLat = 42.7042;
                var centerLng = 0.7961;
                var initialZoom = 6;
                var djoptions = {"layers": [
                            ["OSM", "http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
                                "\u00a9 <a href=\"http://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors"]
                        ],
                            "minimap": false, "scale": "metric", "center": [centerLat, centerLng], "tilesextent": [],
                            "attributionprefix": null, "zoom": initialZoom, "maxzoom": 18, "minzoom": 0, "extent": [
                                [-90,
                                    -180],
                                [90,
                                    180]
                            ], "resetview": true, "srid": null, "fitextent": true},
                        options = {djoptions: djoptions, initfunc: loadmap,
                            globals: false, callback: window.map_init_basic};
                L.Map.djangoMap('erulet_map', options);

                {% for highlight in these_highlights %}
                    L.Map.djangoMap('highlight{{ highlight.id }}', {djoptions: djoptions, initfunc: loadmap,
                        globals: false, callback: eval("window.map_init_highlight{{ highlight.id }}")});
                {% endfor %}

            }

            var loadevents = ["load"];
            if (loadevents.length === 0) loadmap();
            else if (window.addEventListener) for (var i = 0; i < loadevents.length; i++) window.addEventListener(loadevents[i], loadmap, false);
            else if (window.jQuery) jQuery(window).on(loadevents.join(' '), loadmap);
        })();
    </script>

    {{ block.super }}
{% endblock %}