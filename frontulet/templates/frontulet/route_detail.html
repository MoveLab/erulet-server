{% extends "frontulet/base.html" %}
{% load staticfiles %}
{% load leaflet_tags %}

{% block language %}"ca"{% endblock %}
{% block encoding %}<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />{% endblock %}

{% block bootstrap_css %}
    {{ block.super }}
    <link rel="stylesheet" href={% static "frontulet/bootstrap-3.2.0-dist/css/bootstrap-theme.min.css" %}>
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
{% endblock %}

{% block head_additions %}
    <link rel="stylesheet" href={% static "frontulet/form_style.css" %}>

    <link rel="stylesheet" href={% static "frontulet/route_detail_style.css" %}>

    <script src="{% static "frontulet/map_scripts.js" %}"></script>

    {% leaflet_js %}
    {% leaflet_css %}


    <script type="text/javascript">

        var wp_icon_class = L.Icon.Default.extend({
            options: {
                iconUrl: '{% static "frontulet/icons/map_markers/ic_marker_wp.png" %}'
            }
        });

        var poi_icon_class = L.Icon.Default.extend({
            options: {
                iconUrl: '{% static "frontulet/icons/map_markers/ic_marker_poi.png" %}'
            }
        });

        var wp_icon = new wp_icon_class;
        var poi_icon = new poi_icon_class;


        var poi_markers = new L.LayerGroup();
        var wp_markers = new L.LayerGroup();

        var these_latlngs = [];

        {% for step in steps %}

            {% if step.order %}

                these_latlngs[these_latlngs.length] = [{{  step.latitude }}, {{ step.longitude }}];

            {% else %}

                {% for highlight in step.highlights.all %}


                    {% if highlight.type == 1 %}

                        wp_markers.addLayer(L.marker([{{ step.latitude }}, {{ step.longitude }}], {icon: wp_icon}));

                    {% elif highlight.type == 0 %}

                        poi_markers.addLayer(L.marker([{{ step.latitude }}, {{ step.longitude }}], {icon: poi_icon}));


                    {% endif %}

                {% endfor %}

            {% endif %}


        {% endfor %}

        function map_init_basic(map, options) {

            L.polyline(these_latlngs, {weight: 5, opacity: 1, color: 'black'}).addTo(map);
            L.polyline(these_latlngs, {weight: 2, opacity: 1, color: 'red'}).addTo(map);

            var bounds = new L.LatLngBounds(these_latlngs);
            map.fitBounds(bounds);

            wp_markers.addTo(map);
            poi_markers.addTo(map);

        }

    </script>

    <script language="javascript" type="text/javascript">
        function resizeIframe(obj) {
            obj.style.height = obj.contentWindow.document.body.scrollHeight + 'px';
        }
    </script>


{% endblock %}


{% block body_property_extras %}role="document"{% endblock %}

{% block page_id %}routes{% endblock %}

{% block main_body %}

    <div class="container theme-showcase" role="main">

        <div class="page-header">

                      <div id='confirm_delete_route_alert' class='alert alert-warning' role='alert'><p><strong>Warning!</strong>Are you sure you want to delete this route (including all associated highlights, references, interactive images, and content)?</p><br><button onclick="hide_route_alert()" role="button" class='btn btn-success'>No, go back</button> <a class='btn btn-warning' href={% url 'delete_route' id %}>Yes, delete it</a></div>
            <h1>{{ name }}
                <small>{{ short_description }} </small>
                {% if owner %}<a class="btn btn-default btn-sm" href={% url "edit_route" id %} role="button">
                    <span class="glyphicon glyphicon-edit"></span> </a> <button class="btn btn-default" onclick="confirm_delete_route()"> <span class="glyphicon glyphicon-remove-circle"></span> </button> <a class="btn btn-default" href={% url 'make_new_route_reference' id %}> <span class="glyphicon glyphicon-upload"></span>  <span class="glyphicon glyphicon-book"></span> </a>{% endif %}</h1>
            <p>{{ description }}</p>

            {% if has_reference %}
                <button onclick="toggle_iframe('main_ref_div');" type="button" class="btn btn-primary">View Detailed Reference</button>

            {% endif %}

        </div>

        {% if has_reference %}

              <div class='ref_div' id='main_ref_div'>

              <div id='confirm_delete_reference_alert_main' class='alert alert-warning' role='alert'><p><strong>Warning!</strong>Are you sure you want to delete this reference?</p><br><button onclick="hide_alert('_main')" role="button" class='btn btn-success'>No, go back</button> <a class='btn btn-warning' href={% url 'delete_route_reference' id %}>Yes, delete it</a></div>
<br>
    {% if owner %}<a class="btn btn-default" href={% url 'edit_route_reference' id %}> <span class="glyphicon glyphicon-edit"></span> </a> <button class="btn btn-default" onclick="confirm_delete_reference('_main')"> <span class="glyphicon glyphicon-remove-circle"></span> </button>{% endif %}

              {{ reference_html | safe }}
              <br>
              </div>
        {% endif %}


        <div id="erulet_map" class="route_map-container"></div>
        <br>

        {% for highlight in these_highlights %}

            <script>
                eval("function map_init_highlight{{ highlight.id }}(map, options) {L.polyline(these_latlngs, {weight: 5, opacity: 1, color: 'black'}).addTo(map);L.polyline(these_latlngs, {weight: 2, opacity: 1, color: 'red'}).addTo(map);L.marker([{{ highlight.step.latitude }}, {{ highlight.step.longitude }}],{icon:{% if highlight.type == 0 %}poi_icon{% else %}wp_icon{% endif %}}).addTo(map);map.setView([{{ highlight.step.latitude }}, {{ highlight.step.longitude }}], 18)}");
            </script>

            <br>

            <div id="h{{ highlight.id }}" class="row">

                <div class="col-md-4">
                    <h3>{{ highlight.name }}</h3>
                    {% if owner %}
                        <a class="btn btn-default" href={% url "edit_highlight" id highlight.id %} role="button"> <span class="glyphicon glyphicon-edit"></span> </a> <a class="btn btn-default" href={% url 'make_new_highlight_reference' id highlight.id %}> <span class="glyphicon glyphicon-upload"></span>  <span class="glyphicon glyphicon-book"></span> </a> <a class="btn btn-default" href={% url 'create_ii' highlight.id %}> <span class="glyphicon glyphicon-upload"></span>  <span class="glyphicon glyphicon-picture"></span> </a>{% endif %}


                    <p>{{ highlight.long_text }}</p>

                </div>

                <div class="col-md-4">
                {% if highlight.media %}
                    {% if highlight.image %}
                        <a href={{ highlight.media.url }}><img width=100% src={{ highlight.media.url }}></a>
                    {% elif highlight.video %}
                        <video width="100%" height="100%" controls>
                            <source type="video/{{ highlight.media_ext }}" src={{ highlight.media.url }}>
                            Your browser does not support the video tag.
                        </video>
                    {% endif %}
                {% endif %}

                </div>

                <div class="col-md-4">
                    <div id="highlight{{ highlight.id }}" class="highlight-container"></div>
                </div>

            </div>



    {% for ii in highlight.interactive_images %}
<div class="row">

    <a href="{% url 'view_ii' ii.id %}" type="button" class="btn btn-primary"> <span class="glyphicon glyphicon-picture"></span> Interactive Image{% if highlight.interactive_images|length > 1 %} {{ forloop.counter }}{% endif %}
</a>


</div>
<br>

        {% endfor %}


            {% for ref in highlight.references %}
<div class="row">


    <button onclick="toggle_iframe('ref_div{{ ref.id }}');" type="button" class="btn btn-primary"> <span class="glyphicon glyphicon-chevron-down"></span>  <span class="glyphicon glyphicon-book"></span> Reference{% if highlight.references|length > 1 %}: {{ ref.name }}{% endif %}
</button>

</div>

<div class="row">
<div class='ref_div' id='ref_div{{ ref.id }}'>
<div id='confirm_delete_reference_alert{{ ref.id }}' class='alert alert-warning' role='alert'><p><strong>Warning!</strong>Are you sure you want to delete this reference?</p><br><button onclick="hide_alert({{ ref.id }})" role="button" class='btn btn-success'>No, go back</button> <a class='btn btn-warning' href={% url 'delete_highlight_reference' id ref.id %}>Yes, delete it</a></div>
<br>
    {% if owner %}<a class="btn btn-default" href={% url 'edit_highlight_reference' id ref.id %}> <span class="glyphicon glyphicon-edit"></span> </a> <button class="btn btn-default" onclick="confirm_delete_reference({{ ref.id }})"> <span class="glyphicon glyphicon-remove-circle"></span> </button>{% endif %}

              {{ ref.html | safe }}
</div>
</div>
<br>
{% endfor %}
            <div class="border-row"></div>


        {% endfor %}

    </div>


{% endblock %}

{% block body_scripts %}

        {{ block.super }}

    <script type="text/javascript">
        (function () {
            function loadmap() {
                var centerLat = 42.7042;
                var centerLng = 0.7961;
                var initialZoom = 6;
                var djoptions = {"layers": [
                            ["OSM", "http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
                                "\u00a9 <a href=\"http://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors"]
                        ],
                            "minimap": false, "scale": "metric", "center": [centerLat, centerLng], "tilesextent": [],
                            "attributionprefix": null, "zoom": initialZoom, "maxzoom": 18, "minzoom": 0, "extent": [
                                [-90,
                                    -180],
                                [90,
                                    180]
                            ], "resetview": true, "srid": null, "fitextent": true},
                        options = {djoptions: djoptions, initfunc: loadmap,
                            globals: false, callback: window.map_init_basic};
                L.Map.djangoMap('erulet_map', options);

                {% for highlight in these_highlights %}
                    L.Map.djangoMap('highlight{{ highlight.id }}', {djoptions: djoptions, initfunc: loadmap,
                        globals: false, callback: eval("window.map_init_highlight{{ highlight.id }}")});
                {% endfor %}

            }

            var loadevents = ["load"];
            if (loadevents.length === 0) loadmap();
            else if (window.addEventListener) for (var i = 0; i < loadevents.length; i++) window.addEventListener(loadevents[i], loadmap, false);
            else if (window.jQuery) jQuery(window).on(loadevents.join(' '), loadmap);
        })();
    </script>




    <script type="text/javascript">

        $(".ref_div").hide();

        var show = true;

        function toggle_iframe(id) {
        if(show){$("#" + id).show();}else{$("#" + id).hide();}
            show = !show;
        }

        $("img").addClass("img-responsive center-block")


        $(".alert").hide();

    function confirm_delete_reference(ref_id){
        $("#confirm_delete_reference_alert" + ref_id).show();
    }

    function hide_alert(ref_id){
        $("#confirm_delete_reference_alert" + ref_id).hide();
    }


    function confirm_delete_route(){
        $("#confirm_delete_route_alert").show();
    }

    function hide_alert(){
        $("#confirm_delete_route_alert").hide();
    }


    </script>



{% endblock %}